# .github/workflows/build-windows.yml

name: Build for Windows with vcpkg

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      # 第一步：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 第二步：安装 Rust 工具链
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # 第三步 [最终修正]：使用您找到的 johnwason/vcpkg-action 安装 FFmpeg
      - name: Install FFmpeg using vcpkg
        uses: johnwason/vcpkg-action@v7
        id: vcpkg
        with:
          # 需要安装的包
          pkgs: ffmpeg
          # 关键参数：这个目标平台必须和 Rust MSVC 工具链的运行时库完全匹配
          # x64-windows-static-md 是最安全、最正确的选择
          triplet: x64-windows-static-md
          # 根据文档建议，提供 token 以免达到 GitHub API 的速率限制
          token: ${{ github.token }}
          
      # 第四步：缓存 Rust 依赖项
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      # 第五步：编译项目
      # johnwason/vcpkg-action 会自动设置好 VCPKG_ROOT 环境变量
      # Cargo 会自动检测到这个变量并找到 vcpkg 安装的库
      - name: Build Phira
        run: cargo build --release
        shell: bash

      # 第六步：准备打包文件
      - name: Package assets
        run: |
          mkdir release
          cp target/release/phira.exe release/
          cp -r assets release/

      # 第七步：上传构建产物
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phira-windows-build
          path: release/
