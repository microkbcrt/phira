# .github/workflows/build-windows.yml

name: Build for Windows (Official Guide Method)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      # 前六步保持不变，它们已经证明是成功的
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Install Rust toolchain (MinGW)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable-x86_64-pc-windows-gnu
      - name: Setup MSYS2 and install Perl
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: perl
      - name: Download and extract OFFICIAL static libraries
        run: |
          curl -L -o prpr-avc.zip "https://teamflos.github.io/phira-docs/phira_build_guide/prpr-avc.zip"
          unzip -o prpr-avc.zip
        shell: bash
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
      - name: Build Phira
        run: cargo build --release --bin phira-main
        shell: bash

      # 第七步 [已修正]：准备打包文件
      - name: Package assets
        run: |
          # 确保目标目录存在
          mkdir -p target/release/assets
          # 将根目录的 assets 文件夹的内容，复制到 target/release/ 目录下的新 assets 文件夹中
          cp -r assets/* target/release/assets/
        shell: bash

      # 第八步：上传构建产物
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phira-windows-build
          # 我们上传整个 release 文件夹，里面已经包含了 phira-main.exe 和 assets 文件夹
          path: target/release/
