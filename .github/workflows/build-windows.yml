# .github/workflows/build-windows.yml

name: Build for Windows

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022

    steps:
      # 第一步：检出你的代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      # 第二步：安装 Rust 工具链
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # 第三步：安装 LLVM
      - name: Install LLVM
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: '15'

      # 第四步：安装 FFmpeg
      - name: Install FFmpeg
        run: choco install ffmpeg -y

      # 第五步：设置 FFmpeg 环境变量 (新增的关键步骤)
      # 告诉 Rust 编译器去哪里找 FFmpeg 的库文件
      - name: Configure FFmpeg environment
        run: echo "LIBRARY_PATH=$(cygpath -u $(choco path ffmpeg --limit-output))/lib" >> $GITHUB_ENV

      # 第六步：缓存依赖项
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      # 第七步：编译项目
      - name: Build Phira
        run: cargo build --release
        env:
          RUSTFLAGS: "-C target-feature=+crt-static"
          VCPKG_ROOT: "${{ github.workspace }}/vcpkg"
          VCPKGRS_DYNAMIC: "1"

      # 第八步：准备打包文件
      - name: Package assets
        run: |
          mkdir release
          cp target/release/phira.exe release/
          cp -r assets release/

      # 第九步：上传构建产物
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: phira-windows-build
          path: release/
